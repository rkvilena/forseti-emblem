substitutions:
  _REGION: asia-northeast1
  _SERVICE: forsetiemblem-backend
  _IMAGE: forsetiemblem-backend
  _ENVIRONMENT: ""
  _DATABASE_URL: ""
  _OPENAI_API_KEY: ""
  _OPENAI_EMBEDDING_MODEL: ""
  _OPENAI_CHAT_MODEL: ""
  _DOCS_AUTH_ENABLED: ""
  _DOCS_AUTH_MODE: ""
  _DOCS_USERNAME: ""
  _DOCS_PASSWORD: ""
  _DOCS_SESSION_SECRET: ""
  _DOCS_SESSION_TTL_SECONDS: ""
  _TURNSTILE_SECRET_KEY: ""
  _TURNSTILE_ENABLED: ""
  _REDIS_URL: ""
  _RATE_LIMIT_SHORT_WINDOW_SECONDS: ""
  _RATE_LIMIT_SHORT_IP_REQUESTS: ""
  _RATE_LIMIT_LONG_WINDOW_SECONDS: ""
  _RATE_LIMIT_LONG_IP_REQUESTS: ""
  _CORS_ALLOWED_ORIGIN: ""

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  - name: gcr.io/cloud-builders/docker
    env:
      - DOCKER_BUILDKIT=1
    args:
      - build
      - -f
      - infrastructure/cloudbuild/backend/Dockerfile
      - -t
      - gcr.io/$PROJECT_ID/${_IMAGE}:$SHORT_SHA
      - .

  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - gcr.io/$PROJECT_ID/${_IMAGE}:$SHORT_SHA

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_SERVICE}
      - --image
      - gcr.io/$PROJECT_ID/${_IMAGE}:$SHORT_SHA
      - --region
      - ${_REGION}
      - --platform
      - managed
      - --allow-unauthenticated
      - --set-env-vars
      - ENVIRONMENT=${_ENVIRONMENT},DATABASE_URL=${_DATABASE_URL},OPENAI_API_KEY=${_OPENAI_API_KEY},OPENAI_EMBEDDING_MODEL=${_OPENAI_EMBEDDING_MODEL},OPENAI_CHAT_MODEL=${_OPENAI_CHAT_MODEL},DOCS_AUTH_ENABLED=${_DOCS_AUTH_ENABLED},DOCS_AUTH_MODE=${_DOCS_AUTH_MODE},DOCS_USERNAME=${_DOCS_USERNAME},DOCS_PASSWORD=${_DOCS_PASSWORD},DOCS_SESSION_SECRET=${_DOCS_SESSION_SECRET},DOCS_SESSION_TTL_SECONDS=${_DOCS_SESSION_TTL_SECONDS},TURNSTILE_SECRET_KEY=${_TURNSTILE_SECRET_KEY},TURNSTILE_ENABLED=${_TURNSTILE_ENABLED},REDIS_URL=${_REDIS_URL},RATE_LIMIT_SHORT_WINDOW_SECONDS=${_RATE_LIMIT_SHORT_WINDOW_SECONDS},RATE_LIMIT_SHORT_IP_REQUESTS=${_RATE_LIMIT_SHORT_IP_REQUESTS},RATE_LIMIT_LONG_WINDOW_SECONDS=${_RATE_LIMIT_LONG_WINDOW_SECONDS},RATE_LIMIT_LONG_IP_REQUESTS=${_RATE_LIMIT_LONG_IP_REQUESTS},CORS_ALLOWED_ORIGIN=${_CORS_ALLOWED_ORIGIN}

images:
  - gcr.io/$PROJECT_ID/${_IMAGE}:$SHORT_SHA
